name: Security Pipeline v2

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # JOB 1: SECRET SCANNING (Prevents credential leaks)
  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Scan full git history
      
      - name: Run TruffleHog (Find secrets)
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha || 'HEAD~1' }}
          head: HEAD
          
      - name: GitHub Secret Scanning (Native)
        uses: github/codeql-action/init@v2
        with:
          config-file: ./.github/codeql/codeql-config.yml
          
  # JOB 2: CONTAINER SECURITY (What you already have)
  container-scan:
    runs-on: ubuntu-latest
    needs: secret-scan  # Wait for secret scan to pass
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Build Docker image
        run: |
          docker build -t devsecops-app -f docker/Dockerfile app/
      
      - name: Run Trivy vulnerability scanner
        run: |
          # Install Trivy
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          
          # Scan and output to file
          trivy image devsecops-app --severity HIGH,CRITICAL --format table --output trivy-report.txt
          
          # Count results
          HIGH_COUNT=$(grep -c "HIGH" trivy-report.txt || echo "0")
          CRITICAL_COUNT=$(grep -c "CRITICAL" trivy-report.txt || echo "0")
          
          echo "## Container Security Report" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŸ¡ HIGH vulnerabilities: $HIGH_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”´ CRITICAL vulnerabilities: $CRITICAL_COUNT" >> $GITHUB_STEP_SUMMARY
          
          # Fail pipeline if CRITICAL found
          if [ "$CRITICAL_COUNT" -gt "0" ]; then
            echo "âŒ FAIL: Critical vulnerabilities found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      
      - name: Upload scan results
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            trivy-report.txt