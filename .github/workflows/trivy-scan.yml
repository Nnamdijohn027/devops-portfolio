name: Security Pipeline v2

on:
  push:
    paths: ['project-3-devsecops-pipeline/**']
    branches: [main]
  workflow_dispatch:

jobs:
  # JOB 1: SIMPLE SECRET CHECK
  secret-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check for common secrets
        run: |
          echo "ðŸ” Checking for common secrets patterns..."
          # Simple grep for common patterns (adjust as needed)
          grep -r "password\|secret\|key\|token" project-3-devsecops-pipeline/ --exclude-dir=.git 2>/dev/null | head -5 || echo "No obvious secrets found"
          echo "âœ… Basic secret check completed"
      
      - name: GitHub Advanced Security
        uses: github/codeql-action/init@v2
        with:
          languages: python
      
      - name: Analyze
        uses: github/codeql-action/analyze@v2
  
  # JOB 2: CONTAINER SECURITY (FIXED FOR YOUR STRUCTURE)
  container-scan:
    runs-on: ubuntu-latest
    needs: secret-check
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Build Docker image
        working-directory: ./project-3-devsecops-pipeline
        run: |
          docker build -t devsecops-app .
          echo "âœ… Docker build completed"
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'devsecops-app'
          format: 'table'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'  # Don't fail for portfolio
      
      - name: Generate Security Report
        run: |
          echo "## ðŸ”’ Security Pipeline Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Summary" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Secret scanning completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Docker image built successfully" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Trivy vulnerability scan completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review CodeQL findings in Security tab" >> $GITHUB_STEP_SUMMARY
          echo "2. Check Trivy results above for vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "3. For production: Set exit-code to '1' to fail on CRITICAL" >> $GITHUB_STEP_SUMMARY